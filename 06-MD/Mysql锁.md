# Mysql锁

## 一、定义

![1584704399185](SpringCloud.assets\1584704399185.png)

## 二、分类

从数据库的操作类型看：读锁、写锁

从数据库的操作颗粒度看：行锁，表锁

![1584704603444](SpringCloud.assets\1584704603444.png)

## 三、表锁（偏读）

- 特点

```
偏向MyISAM存储引擎，开销小，加锁快；无死锁；锁颗粒度大，发生锁冲突的概率最大，并发度最低。（就例如把学校大门关了，你一个人独享学校）
```

- 手动增加表锁

```
lock table 表名 read/write;
```

- 增加读锁

![1584706979008](SpringCloud.assets\1584706979008.png)

给test1上**读锁**（共享锁），**自己就只能读取数据，其他人也可以读取**；

自己加了锁之后，自己进行写操作会报错：

![1584707442166](SpringCloud.assets\1584707442166.png)

**别人进行写操作会进入阻塞队列，直到解锁**之后才会继续；

- 增加写锁

  ![1584708282564](SpringCloud.assets\1584708282564.png)

  自己：读写都可以

  ![1584708397434](SpringCloud.assets\1584708397434.png)

  别人：读写都阻塞

- 结论

  |                |       自己       |       其他人       |
  | :------------: | :--------------: | :----------------: |
  | 读锁（共享锁） | 可以读，不可以写 | 可以读，写（阻塞） |
  | 写锁（排他锁） |    读写都可以    |   读写都（阻塞）   |

  简言之：读锁阻塞写，写锁阻塞全部

- ![1584708850035](SpringCloud.assets\1584708850035.png)

## 四、行锁（偏写）

- 特点

  ```
  偏向InnoDB存储引擎，开销大，加锁慢，会出现死锁；锁定颗粒度最小，发生锁冲突概率最小，并发最高；
  ```

- InnoDB与MyISAM最大的两个区别：

  1. **支持事务**
  2.  **采用行锁**
  
- 由于行锁支持事务

  并发带来的问题：

  1. 更新丢失

  2. 脏读

  3. 不可重复读

  4. 幻读

     

- 测试：建表sql

  ![1584760889653](SpringCloud.assets\1584760889653.png)

  创建test_innodb_lock表，a、b都是索引

  ![1584767125823](SpringCloud.assets\1584767125823.png)

  两个机器同时操作一条记录，第二个会阻塞，直到第一个commit提交。操作不同的行则不会阻塞

  同时操作同一个a=1那一个记录

  

- **如果索引失效会导致行锁变表锁**

  ![1584768536737](SpringCloud.assets\1584768536737.png)

  ![1584768757006](SpringCloud.assets\1584768757006.png)

  test_innodb_lock表**a、b都是索引**，**本身行锁是有效的**，应该是自己操作的行和别人**操作的行不同都可以执行**；

  **但是**如果类似上图，执行sql时候，**b是varchar类型，忘记写了“”**，则会**导致行锁失效**，**变成表锁**，其他机器进入**阻塞状态**

  

- 间隙所的危害

  ![1584769299657](SpringCloud.assets\1584769299657.png)

  例子：

  ![1584769377899](SpringCloud.assets\1584769377899.png)

  表中数据没有2，但是更新操作使用了**范围检索**，**innoDB会给范围中的所有数上锁**，其他机器无法操作，会阻塞。

  mysql innodb宁可错杀，也要保证修改操作的数据正确。

  危害：

  某些场景下会对性能造成很大危害

  

- 手动给行上锁（此处使用排他锁）

  ![1584769863565](SpringCloud.assets\1584769863565.png)

  锁定的行，其他人修改操作会阻塞，但是可以查看

  

- 行锁总结 

  ![1584770005815](SpringCloud.assets\1584770005815.png)

- ​	优化

  ![1584770419393](SpringCloud.assets\1584770419393.png)

# 五、注意

当innoDB的表，没有设置索引的时候，innoDB只是使用表锁

